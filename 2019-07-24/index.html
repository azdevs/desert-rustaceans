<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Desert Rust - Cross Compiling Rust to Your Pi</title>

      
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;rss.xml">
      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">Desert Rust</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;tags">
                            Topics
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.meetup.com&#x2F;Desert-Rustaceans&#x2F;">
                            Meetup
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.facebook.com&#x2F;groups&#x2F;873973386288785&#x2F;">
                            Facebook
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;azdevs.org">
                            Slack #rust
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;github.com&#x2F;azdevs&#x2F;desert-rustaceans">
                            Github
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans">Desert Rust</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;tags">
                                    Topics
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.meetup.com&#x2F;Desert-Rustaceans&#x2F;">
                                    Meetup
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.facebook.com&#x2F;groups&#x2F;873973386288785&#x2F;">
                                    Facebook
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;azdevs.org">
                                    Slack #rust
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;github.com&#x2F;azdevs&#x2F;desert-rustaceans">
                                    Github
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://azdevs.github.io/desert-rustaceans/2019-07-24/#why-cross-compile-via-jacobrosenthal" class="toc-link">Why Cross compile via @jacobRosenthal</a>
                    
                </li>
                
                <li>
                    <a href="https://azdevs.github.io/desert-rustaceans/2019-07-24/#using-cross-to-cross-compile-via-danielbank" class="toc-link">Using Cross to cross compile via @danielbank</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://azdevs.github.io/desert-rustaceans/2019-07-24/#setup" class="toc-link">Setup</a>
                        </li>
                        
                        <li>
                            <a href="https://azdevs.github.io/desert-rustaceans/2019-07-24/#cross-compilation" class="toc-link">Cross Compilation</a>
                        </li>
                        
                        <li>
                            <a href="https://azdevs.github.io/desert-rustaceans/2019-07-24/#common-reasons-your-build-is-failing" class="toc-link">Common Reasons Your Build is Failing</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://azdevs.github.io/desert-rustaceans/2019-07-24/#hands-on-blink-an-led-on-a-raspberry-pi-via-jacobrosenthal" class="toc-link">Hands on: blink an led on a raspberry pi via @jacobRosenthal</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;2019-07-24&#x2F;">Cross Compiling Rust to Your Pi</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-07-24</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>Daniel Bank has been working with Snips offline machine learning stack and explains the ins and outs of cross compiling for a different architecture than you're machine.</p>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<h3 id="why-cross-compile-via-jacobrosenthal">Why Cross compile via <a href="https://github.com/jacobRosenthal">@jacobRosenthal</a></h3>
<p>We can technically compile just fine for rapsberry pi if we add the target:
<code>rustup target add armv7-unknown-linux-gnueabihf</code></p>
<p>But well get this error when we build for our target</p>
<pre style="background-color:#fafafa;">
<span style="color:#f29718;">$</span><span style="color:#61676c;"> cargo build</span><span style="color:#ff8f40;"> --target</span><span style="color:#61676c;"> armv7-unknown-linux-gnueabihf
   </span><span style="color:#f29718;">Compiling</span><span style="color:#61676c;"> pi-example v0.1.0 (/Users/jacobrosenthal/Downloads/pi-example)
</span><span style="color:#f29718;">error:</span><span style="color:#61676c;"> linker `</span><span style="color:#f29718;">arm-linux-gnueabihf-gcc</span><span style="color:#61676c;">` not found
  </span><span style="color:#ed9366;">|
  = </span><span style="color:#f29718;">note:</span><span style="color:#61676c;"> No such file or directory (os error 2)
</span><span style="color:#f29718;">error:</span><span style="color:#61676c;"> aborting due to previous error
</span><span style="color:#f29718;">error:</span><span style="color:#61676c;"> Could not compile `</span><span style="color:#f29718;">pi-example</span><span style="color:#61676c;">`.
</span><span style="color:#f29718;">To</span><span style="color:#61676c;"> learn more, run the command again with</span><span style="color:#ff8f40;"> --verbose</span><span style="color:#61676c;">.
</span></pre>
<p>So we need a linker, in this case its probably called something very near arm-linux-gnueabihf-gcc</p>
<p>These toolchains are generally very available for bare metal &quot;no_std&quot; cortex devices. You might remember from other workshops they just have us quickly <a href="https://rust-embedded.github.io/book/intro/install/macos.html">install the toolchain as the first step</a></p>
<p>But were not targeting &quot;no_std&quot; raspberry pi, were targeting linux on top of pi, so we can use all the Rust &quot;std&quot; libraries.</p>
<p>As an aside, if you want to check out no_std raspberry pi stuff, I recommend <a href="http://os.phil-opp.com">Phillip Oppermans blog series</a> which is basically a CS Degree in building an operating system from scratch on the rasperry pi</p>
<p>So if were in linux its probably actually <a href="https://hackernoon.com/compiling-rust-for-the-raspberry-pi-49fdcd7df658">not that hard to get the raspberry pi toolchain linker</a>. Something like <code>sudo apt-get install gcc-4.7-multilib-arm-linux-gnueabihf</code> would probably work</p>
<p>Then create a .cargo/config file and add</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">[build]
target = &quot;armv7-unknown-linux-gnueabihf&quot;

[target.armv7-unknown-linux-gnueabihf]
linker = &quot;arm-linux-gnueabihf-gcc-4.7&quot;
</span></pre>
<p>and <code>cargo build</code> should work for you! Congrats you dont need cross (today).</p>
<p>But on Mac that toolchain is for some reason just not commonly hosted anywhere in brew etc. The best Ive found is this million page medium article <a href="https://medium.com/coinmonks/setup-gcc-8-1-cross-compiler-toolchain-for-raspberry-pi-3-on-macos-high-sierra-cb3fc8b6443e">Setup GCC 8.1 Cross Compiler Toolchain for Raspberry Pi 3 on macOS High Sierra</a></p>
<p>But you know whats better than doing all that yourself and polluting your machine? Having someone else do work for you and packaging it in a reusable cross platform way. Maybe with something like .. a docker container.. Enter <a href="https://github.com/rust-embedded/cross">Cross</a></p>
<h3 id="using-cross-to-cross-compile-via-danielbank">Using Cross to cross compile via <a href="https://github.com/danielbank">@danielbank</a></h3>
<h4 id="setup">Setup</h4>
<ul>
<li>
<p>Install <a href="https://www.docker.com/get-started">Docker</a></p>
</li>
<li>
<p>Add Rust targets</p>
<pre style="background-color:#fafafa;">
<span style="color:#f29718;">rustup</span><span style="color:#61676c;"> target add armv7-unknown-linux-gnueabihf </span><span style="font-style:italic;color:#abb0b6;"># Pi
</span><span style="color:#f29718;">rustup</span><span style="color:#61676c;"> target add arm-unknown-linux-gnueabihf </span><span style="font-style:italic;color:#abb0b6;"># Pi Zero
</span><span style="color:#f29718;">rustup</span><span style="color:#61676c;"> target list
</span></pre></li>
<li>
<p>Install <a href="https://github.com/rust-embedded/cross">cross</a></p>
<pre style="background-color:#fafafa;">
<span style="color:#f29718;">cargo</span><span style="color:#61676c;"> install</span><span style="color:#ff8f40;"> --force --git</span><span style="color:#61676c;"> https://github.com/rust-embedded/cross cross
</span></pre></li>
</ul>
<h4 id="cross-compilation">Cross Compilation</h4>
<ul>
<li>
<p>Docker has to be <strong>running</strong> or you will get errors!</p>
</li>
<li>
<p>Go to the code directory you want to build</p>
</li>
<li>
<p>Build the code with cross</p>
<pre style="background-color:#fafafa;">
<span style="color:#f29718;">cross</span><span style="color:#61676c;"> build</span><span style="color:#ff8f40;"> --target</span><span style="color:#ed9366;">=</span><span style="color:#61676c;">armv7-unknown-linux-gnueabihf
</span></pre></li>
</ul>
<h4 id="common-reasons-your-build-is-failing">Common Reasons Your Build is Failing</h4>
<ul>
<li>
<p>Did you use <code>cargo</code> or <code>cross</code>? If cross compiling, you must use <code>cross</code>.</p>
</li>
<li>
<p>Did you specify a target? If you don't specify a target in the build command or haven't set it up in a <a href="https://doc.rust-lang.org/cargo/reference/config.html">.cargo/config</a>, <code>cross</code> will just build for your local architecture.</p>
</li>
<li>
<p>Are you getting errors similar to the following?</p>
<pre style="background-color:#fafafa;">
<span style="color:#f29718;">error:</span><span style="color:#61676c;"> failed to load source for a dependency on </span><span style="color:#4cbf99;">\`</span><span style="color:#61676c;">tract-core</span><span style="color:#4cbf99;">\`
</span></pre>
<p>I was able to resolve these errors by specifying a <code>--manifest-path</code>:</p>
<pre style="background-color:#fafafa;">
<span style="color:#f29718;">cross</span><span style="color:#61676c;"> build</span><span style="color:#ff8f40;"> --target</span><span style="color:#ed9366;">=</span><span style="color:#61676c;">armv7-unknown-linux-gnueabihf</span><span style="color:#ff8f40;"> --manifest-path</span><span style="color:#ed9366;">=</span><span style="color:#61676c;">examples/tensorflow-mobilenet-v2/Cargo.toml
</span></pre></li>
<li>
<p>Is there a supported Docker image for the target architecture? I noticed when trying to build for a Pi Zero that I couldn't find a Docker image for the <code>arm-unknown-linux-gnueabihf</code> target. In my case, someone published their own <a href="https://hub.docker.com/r/rustreleaser/cross">Docker image</a> which I found from a <a href="https://github.com/rust-embedded/cross/issues/261">GitHub Issue</a></p>
<pre style="background-color:#fafafa;">
<span style="color:#f29718;">Unable</span><span style="color:#61676c;"> to find image </span><span style="color:#86b300;">&#39;japaric/arm-unknown-linux-gnueabihf:latest&#39;</span><span style="color:#61676c;"> locally
</span></pre></li>
</ul>
<h3 id="hands-on-blink-an-led-on-a-raspberry-pi-via-jacobrosenthal">Hands on: blink an led on a raspberry pi via <a href="https://github.com/jacobRosenthal">@jacobRosenthal</a></h3>
<p>My crate you should know is <a href="https://github.com/golemparts/rppal">Rppal</a> which has the fastest gpio access for raspberry pi</p>
<p>Theres a great <a href="https://github.com/golemparts/rppal/blob/b03a7b3c42c8c81c3222823266534c5554fe5843/examples/gpio_blinkled.rs">blink example included</a></p>
<p>On your machine, assuming you have rust and cross installed lets make a new project with <code>cargo new pi-example &amp;&amp; cd pi-example</code></p>
<p>Then we have to add the rppal dependency to Cargo.toml like</p>
<pre style="background-color:#fafafa;">
<span style="color:#61676c;">[</span><span style="color:#399ee6;">dependencies</span><span style="color:#61676c;">]
</span><span style="color:#399ee6;">rppal </span><span style="color:#61676c;">= </span><span style="color:#86b300;">&quot;0.11.3&quot;
</span></pre>
<p>Now lets replace the src/main.rs with that example above. Ive put an led on our pi here on pin14 so change 23 to 14. <a href="https://pinout.xyz">This</a> is agreat pinout site for raspberry pi</p>
<p>And were ready, compile with cross as daniel showed <code>cross build --target armv7-unknown-linux-gnueabihf</code></p>
<p>Now, thanks to heatsync, andrew and @finkegabriel we have a pi cluster networked at Heatsync available at pi@pinode[1-8] (ie pi@pinode1 ie pi@pinode2) with password raspberry</p>
<p>Now lets push our compiled executable over to a pi. Im going to use pinode1 and a tool called scp to send files over ssh to another device. Your compiled file is probably sitting at target/armv7-unknown-linux-gnueabihf/debug/pi-example so lets <code>scp target/armv7-unknown-linux-gnueabihf/debug/pi-example pi@pinode1.local:/home/pi</code></p>
<p>And now lets ssh into our pi and run it like <code>ssh pi@pinode1.local</code> then <code>./pi-example</code></p>
<p>Now hopefully you can see your led blinking away. You can [ctrl-c] to kill the program and type 'exit' to get out of ssh back to your computer and make some changes. Can you blink at a different rate, a random rate, a sin wave so it looks like a heart beat? println! some stuff? Theres also i2c and many other protocols in the rppal library for you to try. Find some sensors and motors and other hardware.</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;tags&#x2F;embedded&#x2F;">#Embedded</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;2019-05-22&#x2F;">‹ Backend Web Frameworks</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;2019-08-28&#x2F;">Frontend Web ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;azdevs.github.io&#x2F;desert-rustaceans&#x2F;even.js" ></script>
      
    </body>

</html>
