+++
title = "Bevy Game Engine, Embedded Graphics Updates, and Enforcing API Spec with Traits"
date = 2021-05-26
draft = false
in_search_index = true
template = "page.html"

[taxonomies] 
tags = ["Games", "Embedded", "Web", "Server"]
categories = ["meetups"]
+++

Topics:

-   Wheel of Names with Bevy via [@DanielPBank](https://github.com/danielbank)
-   Embedded Graphics Updates via [@jacobrosenthal](https://github.com/jacobrosenthal)
-   Making a Tiny Game with Raylib via [@mysteriouspants](https://github.com/mysteriouspants)

<!-- more -->

# Wheel of Names with Bevy via [@DanielPBank](https://github.com/danielbank)

Repo: [https://github.com/danielbank/ferris-wheel](https://github.com/danielbank/ferris-wheel)

I'm attempting to build a Rust port of the [Wheel of Names JS App](https://wheelofnames.com/) using [Bevy Game Engine](https://bevyengine.org/). Currently, Bevy does not support drawing custom shapes in an easy way. Fortunately, there is a Bevy plugin called, [bevy_prototype_lyon](https://github.com/Nilirad/bevy_prototype_lyon) which provides this functionality using [lyon](https://crates.io/crates/lyon), which implements 2D Graphics rendering on the GPU using tessellation.

## Make a Wheel

I started with the [bevy_prototype_lyon example code](https://github.com/Nilirad/bevy_prototype_lyon/blob/master/examples/readme_example.rs) and made a circle. The code for this is straightforward

```
let wheel = shapes::Circle {
    radius: 200.0,
    ..shapes::Circle::default()
};

commands.spawn_bundle(GeometryBuilder::build_as(
    &wheel,
    ShapeColors::outlined(Color::TOMATO, Color::BLACK),
    DrawMode::Outlined {
        fill_options: FillOptions::default(),
        outline_options: StrokeOptions::default().with_line_width(10.0),
    },
    Transform::default(),
));
```

## Make the Wheel Spin

To figure out how to do motion, I copied from the [Bevy Breakout Game example](https://github.com/bevyengine/bevy/blob/latest/examples/game/breakout.rs), here I learned some things that surprised me.

### Query Components Not Entities

Bevy follows the [Entity Component System paradigm](https://bevyengine.org/learn/book/getting-started/ecs/) so we need to understand a little bit about that in order to move things. Specifically to move an entity, we need to first query for a component of that specific entity before applying transformations:

```
if let Ok((ball, mut transform)) = ball_query.single_mut() {
    transform.translation += ball.velocity * delta_seconds;
}
```

Naively, we may want to try to do something with the Shapes (e.g. `wheel = shapes::Circle { ... }`) or the ShapeBundles (e.g. `GeometryBuilder::build_as( ... )`) to get them to move. However, [Bevy wants us to interact with Components](https://bevy-cheatbook.github.io/programming/queries.html) which are structs attached to Entities. We attach these components to entities by calling `.insert()` on the ShapeBundle we get back from `GeometryBuilder::build_as( ... )`.

```
commands
    .spawn_bundle(GeometryBuilder::build_as( ... )
    .insert(Component {});
```

The components could even be an empty structs, we simply need something to get a handle on when we query the system for things to transform.

Since I wanted to apply my rotation movement to all the Entities in my app, I didn't use `single_mut()`, which matches a single entity, and instead iterated over:

```
particles_query
  .iter_mut()
  .for_each(|(particle, mut transform)| {
      transform.rotate(Quat::from_rotation_z(FRAC_PI_2));
  });
```

## Caveat about Getting Past an Initial wgpu Validation Error

When I first tried running the [bevy_prototype_lyon example code](https://github.com/Nilirad/bevy_prototype_lyon/blob/master/examples/readme_example.rs), I was getting the following error:

```
wgpu error: Validation Error

Caused by:
    In a RenderPass
      note: encoder = `<CommandBuffer-(1, 2, Metal)>`
    In a pass parameter
      note: command buffer = `<CommandBuffer-(1, 2, Metal)>`
    attachment's sample count 8 is invalid
```

I fixed this issue by changing the `Msaa { samples: 8 }` to `Msaa { samples: 4 }`. Some light reading on [Multisample anti-aliasing](https://en.wikipedia.org/wiki/Multisample_anti-aliasing#Sample_patterns) revealed that most modern GPUs support 2×, 4×, and 8× MSAA samples. It looks like my 2015 MacBook Pro is starting to show its age.

# Embedded Graphics Updates via [@jacobrosenthal](https://github.com/jacobrosenthal)

The [embedded-graphics](https://crates.io/crates/embedded-graphics) crate is getting close to a 0.7.0 release and lots of cool stuff is now possible.

-   [Embedded Graphics Simulator](https://github.com/embedded-graphics/simulator): You don't have to run on a device to test your graphics, you can run in the simulator which opens an SDL2 window for previewing. Here is [a tweet demo'ing compound animations](https://twitter.com/jam_waffles/status/1397284559310499845) (made using the simulator).

-   [Embedded Graphics GUI](https://github.com/bugadani/embedded-gui): Building upon the low-level code of the embedded-graphics crate, there is work going into building a composable UI framework which allows building more complex UI. Here is [a tweet demo'ing of the new UI framework in action](https://twitter.com/bugadani/status/1393688049322807310?s=20).

-   [Embedded Text](https://github.com/embedded-graphics/embedded-text): Provides TextBox functionality (how do you flow text into a box, align the text, prevent it from overflowing, etc.) Here is a demo of a [typing animation](https://matrix-client.matrix.org/_matrix/media/r0/download/matrix.org/kZCiAfZHziMLAOCFuekUkgsk).

-   Here are [Even More Embedded Graphics Examples](https://github.com/embedded-graphics/examples/tree/main/eg-next)

The [Pygamer Board Support Crate](https://github.com/atsamd-rs/atsamd/tree/master/boards/pygamer) already uses (an older version of) embedded-graphics, so a lot of these recent advancements can hopefully be made available in it soon.

# Enforcing API Spec with Traits via [@JesusGuzmanJr](https://github.com/JesusGuzmanJr)

Jesus to fill in details...

# Making a Tiny Game with Raylib via [@mysteriouspants](https://github.com/mysteriouspants)

Chris is participating in the [4MB Game Jam](https://itch.io/jam/4mb) this month. As per the name, game submissions need to be smaller than 4mb. Chris is making his game with Rust using the [raylib](https://crates.io/crates/raylib) crate, which provides Rust bindings for [raylib](https://www.raylib.com/), a C library for making video games. Part of the fun is optimizations, including trimming down raylib to not include modules that he isn't using. The full raylib library is around 1MB in size, but by trimming out what he isn't using, Chris can get the final dependency to only 40KB!

# Crates You Should Know

-   [lyon](https://crates.io/crates/lyon): 2D Graphics rendering on the GPU using tessellation
-   [bevy_prototype_lyon](https://crates.io/crates/bevy_prototype_lyon): Draw 2D shapes and paths in the Bevy game engine
-   [raylib](https://crates.io/crates/raylib): Safe Rust bindings for Raylib
